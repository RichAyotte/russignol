# Genimage configuration for Raspberry Pi Zero 2W with F2FS rootfs
#
# Factory image contains only Boot + RootFS partitions.
# Keys (p3) and Data (p4) partitions are created dynamically at first boot
# with hardware-adaptive alignment based on SD card's discard granularity.
#
# Partition layout (all 16MB-aligned for optimal flash wear leveling):
# - 0-16MB: Unused (MBR at sector 0, rest becomes over-provisioning)
# - Partition 1: FAT32 boot (32MB @ 16MB offset) with firmware and kernel
# - Partition 2: F2FS rootfs (~256MB @ 48MB offset, compressed)
# - Partitions 3-4: Created at runtime by rpi-signer first-boot setup

image boot.vfat {
	vfat {
		files = {
			"bcm2710-rpi-zero-2-w.dtb",
			"rpi-firmware/bootcode.bin",
			"rpi-firmware/cmdline.txt",
			"rpi-firmware/config.txt",
			"rpi-firmware/fixup.dat",
			"rpi-firmware/overlays",
			"rpi-firmware/start.elf",
			"Image",
		}
	}

	size = 32M
}

image sdcard.img {
	hdimage {
		# 16MB alignment for all partitions - matches most SD card erase block sizes
		# This prevents Read-Modify-Write penalty and maximizes wear leveling efficiency
		align = 16M
	}

	partition boot {
		partition-type = 0xC
		bootable = "true"
		image = "boot.vfat"
		offset = 16M  # 16MB-aligned (unused 15MB becomes over-provisioning)
	}

	partition rootfs {
		partition-type = 0x83
		image = "rootfs.f2fs"
		# Starts at first 16MB boundary after boot partition
	}

	# Keys and Data partitions removed - created at first boot with:
	# - Hardware-detected alignment (from discard_granularity)
	# - TRIM/discard optimization
	# - F2FS inline_data/inline_dentry for small file efficiency
	# - Over-provisioning (remaining space left unpartitioned)
}
